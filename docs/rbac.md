
### RBAC인가 플러그인
RBAC는 사용자가 클러스터 내의 자원에 대해 접근하고 사용할 수 있는지 점검하고 설정할 수 있습니다. 

`쿠버네티스 API와 통신하는 애플리케이션을 작성`하려면 RBAC 관련 리소스로 권한을 관리하는 방법을 알아야합니다.

쿠버네티스 API서버는 인가 플러그인(RBAC)을 사용해 `액션`을 요청하는 사용자가 액션을 수행할 수 있는지 확인합니다.

액션을 요청할 때, 사용자는 자격증명(토큰, 인증서)을 포함시켜 자신을 인증해야합니다.

### 액션
액션은 REST 클라이언트를 통해 특정 리소스를 나타내는 URL 경로를 보냅니다.

액션에 관한 예시들입니다.
- 파드 요청
- 서비스 생성
- 서비스 업데이트

이런 액션들은 REST API 형식에 맞게 `HTTP 메소드`, `리소스에 대한 행동(동사)`, `컬렉션에 대한 행동(동사)` 로 이루어집니다. 아래 테이블이 액션에 과 HTTP 메서드가 매핑된 예시입니다.

| HTTP 메소드 | 단일 리소스에 관한 동사      | 컬렉션에 관한 동사      |
|-------------|------------------------------|-------------------------|
| GET, HEAD   | get (and watch for watching) | list (and watch)        |
| POST        | create                       | n/a                     |
| PUT         | update                       | n/a                     |
| PATCH       | patch                        | n/a                     |
| DELETE      | delete                       | delete collection       |

API 서버의 모든 경로가 리소스를 매핑한 것은 아니기 때문에, 리소스가 아닌 URL에도 권한을 적용할 수 있습니다. ex) /heartbeat 등등

### RBAC 리소스
RBAC는 `롤이라는 리소스로 사용자가 액션을 수행할 수 있는지` 확인합니다. 주체(사용자, 서비스어카운트, 그룹(사용자, 서비스어카운트))는 한 개 이상의 롤과 연계돼 있으며, 롤바인딩을 통해 사용자는 특정 리소스에 대한 권한을 가지고 있습니다.

파드 조회에만 하는 롤을 가진 사용자는 파드에 대해 POST(생성), DELETE(삭제)할 수 없습니다.

RBAC 인가 클러스터는 4개의 리소스로 구성됩니다.
- 롤, 클러스터롤: 리소스에 수행할 수 있는 동사 지정
- 롤바인딩, 클러스터롤바인딩: 위의 롤을 특정 사용자, 서비스어카운트, 그룹에 바인딩합니다.

롤은 작업에 대해 명시가 되어 있고 바인딩은 누가 어떤 롤을 사용하는지 정의합니다.

![image](./images/role.png)

롤과 롤바인딩은 `네임스페이스가 지정된 리소스`이고 `클러스터롤과 클러스터롤바인딩`은 네임스페이스를 지정하지 않는 클러스터 수준의 리소스입니다.

![image](./images/namespace-cluster.png)

그림을 보면 네임스페이스가 1개 이상의 롤 바인딩을 가질 수 있고, 네임스페이스가 지정되지 않은 클러스터롤도 참조할 수 있습니다. 

아래는 네임스페이스 범위와 클러스터 범위의 리소스들입니다.

네임스페이스 범위의 리소스
- Pods
- Services
- Deployments
- ReplicaSets
- StatefulSets
- PersistentVolumeClaims
- ConfigMaps
- Secrets
- Jobs
- CronJobs


클러스터 범위의 리소스
- Nodes
- Namespaces
- PersistentVolumes
- StorageClasses

만약 클러스터 범위의 리소스(node)에 대한 클러스터롤이 바인딩이 되어 있는 사용자는 그 노드에 있는 `네임스페이스 범위의` 리소스에 대한 정보를 가져올 수 있습니다.

```
롤: 특정 네임스페이스 내에서만 권한을 정의합니다. 해당 네임스페이스 내의 리소스에만 접근 권한을 설정합니다.

클러스터롤: 클러스터 전체에서 권한을 정의합니다. 모든 네임스페이스와 클러스터 범위의 리소스에 대한 접근 권한을 설정합니다.
```

롤과 클러스터롤을 분리하여 접근을 제어하는 이유는 다음과 같습니다.
- 보안
  - 특정 네임스페이스 내에서만 최소한 권한을 부여합니다.
  - 네임스페이스별로 세밀한 권한 관리를 할 수 있습니다.
- 관리
  - 네임스페이스 별로 권한을 설정함으로써, 특정 네임스페이스만 작업하는 팀이나 애플리케이션에 대해 독립적으로 권한을 줄 수 있습니다.

사용 사례
- 롤
  - 개발팀이 특정(개발) 네임스페이스에서만 작업해야 하는 경우, 해당 네임스페이스에 대한 리소스 권한 부여
- 클러스터롤
  - 관리자가 클러스터 전체에 대한 리소스가 필요한 경우
  - 모니터링 같은 모든 리소스를 필요로 하는 리소스를 사용할 때

